{
  "manifest_version": "2",
  "task_list": [
    {
      "name": "Cellpose SAM Segmentation",
      "category": "Segmentation",
      "tags": [
        "Deep Learning",
        "Convolutional Neural Network",
        "Instance Segmentation",
        "2D",
        "3D",
        "Cellpose",
        "SAM"
      ],
      "docs_info": "### Purpose\n- Description and documentation of the Task functionality\n- Bullet points that cover main features of the tasks.\n- Can use **full** *markdown* formatting (including embedding images).\n\n### Outputs\n- Optional section on what kind of outputs the task generates. For the thresholding_task: Generates a new label image named `label_name`.\n\n### Limitations\n- List known limitations of the task (e.g. only works for certain data types).",
      "type": "parallel",
      "executable_parallel": "cellpose_sam_segmentation_task.py",
      "meta_parallel": {
        "cpus_per_task": 4,
        "mem": 16000,
        "needs_gpu": true
      },
      "args_schema_parallel": {
        "$defs": {
          "AdvancedCellposeParameters": {
            "description": "Advanced Cellpose Model Parameters.",
            "properties": {
              "normalization": {
                "default": {
                  "mode": "default"
                },
                "discriminator": {
                  "mapping": {
                    "custom": "#/$defs/CustomNorm",
                    "default": "#/$defs/DefaultNorm",
                    "none": "#/$defs/NoNorm"
                  },
                  "propertyName": "mode"
                },
                "oneOf": [
                  {
                    "$ref": "#/$defs/DefaultNorm"
                  },
                  {
                    "$ref": "#/$defs/NoNorm"
                  },
                  {
                    "$ref": "#/$defs/CustomNorm"
                  }
                ],
                "title": "Normalization",
                "description": "Normalization model to use. Options are DefaultNorm (use Cellpose default normalization), NoNorm (disable normalization), or CustomNorm (full control over normalization parameters). Defaults to DefaultNorm()."
              },
              "batch_size": {
                "default": 8,
                "title": "Batch Size",
                "type": "integer",
                "description": "Number of 256x256 patches to run simultaneously on the GPU (can make smaller or bigger depending on GPU memory usage). Defaults to 8."
              },
              "resample": {
                "default": true,
                "title": "Resample",
                "type": "boolean",
                "description": "Run dynamics at original image size (will be slower but create more accurate boundaries). Defaults to True."
              },
              "invert": {
                "default": false,
                "title": "Invert",
                "type": "boolean",
                "description": "Invert image pixel intensity before running network. Defaults to False."
              },
              "diameter": {
                "title": "Diameter",
                "type": "number",
                "description": "Diameter used to rescale the image to 30 pix cell diameter. Defaults to None."
              },
              "flow_threshold": {
                "default": 0.4,
                "title": "Flow Threshold",
                "type": "number",
                "description": "Flow error threshold (all cells with errors below threshold are kept) (not used for 3D). Defaults to 0.4."
              },
              "cellprob_threshold": {
                "default": 0.0,
                "title": "Cellprob Threshold",
                "type": "number",
                "description": "All pixels with value above threshold kept for masks, decrease to find more and larger masks. Defaults to 0.0."
              },
              "flow3D_smooth": {
                "default": 0,
                "title": "Flow3D Smooth",
                "type": "integer",
                "description": "If do_3D and flow3D_smooth>0, smooth flows with gaussian filter of this stddev. Defaults to 0."
              },
              "anisotropy": {
                "title": "Anisotropy",
                "type": "number",
                "description": "For 3D segmentation, rescaling factor (e.g. set to 2.0 if Z is sampled half as dense as X or Y). Defaults to None."
              },
              "do_3D": {
                "default": true,
                "title": "Do 3D",
                "type": "boolean",
                "description": "Whether to perform 3D segmentation. If set to False for a 3D image, the image will be segmented by XY planes independently and then stitched together in 3D using the stitch_threshold parameter. If set to True for a 2D image, this will be ignored."
              },
              "stitch_threshold": {
                "default": 0.0,
                "title": "Stitch Threshold",
                "type": "number",
                "description": "If stitch_threshold>0.0 and not do_3D, masks are stitched in 3D to return volume segmentation. Defaults to 0.0."
              },
              "min_size": {
                "default": 15,
                "title": "Min Size",
                "type": "integer",
                "description": "All ROIs below this size, in pixels, will be discarded. Defaults to 15."
              },
              "max_size_fraction": {
                "default": 0.4,
                "title": "Max Size Fraction",
                "type": "number",
                "description": "Masks larger than max_size_fraction of total image size are removed. Defaults to 0.4."
              },
              "niter": {
                "title": "Niter",
                "type": "integer",
                "description": "Number of iterations for dynamics computation. If None, it is set proportional to the diameter. Defaults to None."
              },
              "augment": {
                "default": false,
                "title": "Augment",
                "type": "boolean",
                "description": "Tiles image with overlapping tiles and flips overlapped regions to augment. Defaults to False."
              },
              "tile_overlap": {
                "default": 0.1,
                "title": "Tile Overlap",
                "type": "number",
                "description": "Fraction of overlap of tiles when computing flows. Defaults to 0.1."
              },
              "bsize": {
                "default": 256,
                "title": "Bsize",
                "type": "integer",
                "description": "Block size for tiles, recommended to keep at 224, like in training. Defaults to 256."
              },
              "verbose": {
                "default": false,
                "title": "Verbose",
                "type": "boolean",
                "description": "Whether cellpose logs should be active. Defaults to False."
              }
            },
            "title": "AdvancedCellposeParameters",
            "type": "object"
          },
          "CellposeChannels": {
            "description": "Cellpose channels configuration.",
            "properties": {
              "mode": {
                "default": "label",
                "enum": [
                  "label",
                  "wavelength_id",
                  "index"
                ],
                "title": "Mode",
                "type": "string",
                "description": "Specifies how to interpret the identifier. Can be \"label\", \"wavelength_id\", or \"index\" (must be an integer)."
              },
              "identifiers": {
                "items": {
                  "type": "string"
                },
                "maxItems": 3,
                "minItems": 1,
                "title": "Identifiers",
                "type": "array",
                "description": "Unique identifiers for the channels. This can be channel labels, wavelength IDs, or indices. At least one and at most three identifiers must be provided."
              }
            },
            "required": [
              "identifiers"
            ],
            "title": "CellposeChannels",
            "type": "object"
          },
          "CreateMaskingRoiTable": {
            "description": "Create Masking ROI Table Configuration.",
            "properties": {
              "mode": {
                "const": "Create Masking ROI Table",
                "default": "Create Masking ROI Table",
                "title": "Mode",
                "type": "string",
                "description": "Mode to create masking ROI table."
              },
              "table_name": {
                "default": "{label_name}_masking_ROI_table",
                "title": "Table Name",
                "type": "string",
                "description": "Name of the masking ROI table to be created. Defaults to \"{label_name}_masking_ROI_table\", where {label_name} is the name of the label image used for segmentation."
              }
            },
            "title": "CreateMaskingRoiTable",
            "type": "object"
          },
          "CustomNorm": {
            "description": "Custom Cellpose normalization.",
            "properties": {
              "mode": {
                "const": "custom",
                "default": "custom",
                "title": "Mode",
                "type": "string",
                "description": "Use custom normalization with full control over parameters."
              },
              "normalize": {
                "default": true,
                "title": "Normalize",
                "type": "boolean",
                "description": "Whether to perform normalization. Defaults to True."
              },
              "norm3D": {
                "default": false,
                "title": "Norm3D",
                "type": "boolean",
                "description": "Whether to normalize in 3D. If True, the entire 3D stack will be normalized per channel. If False, normalization is applied per Z-slice. Defaults to False."
              },
              "invert": {
                "default": false,
                "title": "Invert",
                "type": "boolean",
                "description": "Whether to invert the image. Useful if cells are dark instead of bright. Defaults to False."
              },
              "use_lowhigh": {
                "default": false,
                "title": "Use Lowhigh",
                "type": "boolean",
                "description": "Whether to use lowhigh normalization. If False, percentile normalization will be used instead. Defaults to False."
              },
              "lowhigh": {
                "default": [
                  0.0,
                  1000.0
                ],
                "maxItems": 2,
                "minItems": 2,
                "prefixItems": [
                  {
                    "type": "number"
                  },
                  {
                    "type": "number"
                  }
                ],
                "title": "Lowhigh",
                "type": "array",
                "description": "The lower and upper bounds for normalization. Incompatible with smoothing and sharpening. Defaults to (0.0, 1000.0)."
              },
              "percentile": {
                "default": [
                  1.0,
                  99.0
                ],
                "maxItems": 2,
                "minItems": 2,
                "prefixItems": [
                  {
                    "type": "number"
                  },
                  {
                    "type": "number"
                  }
                ],
                "title": "Percentile",
                "type": "array",
                "description": "The lower and upper percentiles for normalization. Each value should be between 0 and 100. If use_lowhigh is True, this parameter is ignored. Defaults to (1.0, 99.0)."
              },
              "sharpen_radius": {
                "default": 0.0,
                "title": "Sharpen Radius",
                "type": "number",
                "description": "The radius for sharpening the image. Defaults to 0.0."
              },
              "smooth_radius": {
                "default": 0.0,
                "title": "Smooth Radius",
                "type": "number",
                "description": "The radius for smoothing the image. Defaults to 0.0."
              },
              "tile_norm_blocksize": {
                "default": 0,
                "title": "Tile Norm Blocksize",
                "type": "integer",
                "description": "The block size for tile-based normalization. Defaults to 0."
              },
              "tile_norm_smooth3D": {
                "default": 1,
                "title": "Tile Norm Smooth3D",
                "type": "integer",
                "description": "The smoothness factor for tile-based normalization in 3D. Defaults to 1."
              },
              "axis": {
                "default": -1,
                "title": "Axis",
                "type": "integer",
                "description": "The channel axis to loop over for normalization. Defaults to -1."
              }
            },
            "title": "CustomNorm",
            "type": "object"
          },
          "DefaultNorm": {
            "description": "Default Cellpose normalization.",
            "properties": {
              "mode": {
                "const": "default",
                "default": "default",
                "title": "Mode",
                "type": "string",
                "description": "Use Cellpose default normalization (0-1 rescaling and 1%-99% percentile clipping). All other parameters are ignored."
              }
            },
            "title": "DefaultNorm",
            "type": "object"
          },
          "GaussianFilter": {
            "description": "Gaussian pre-processing configuration.",
            "properties": {
              "type": {
                "const": "gaussian",
                "default": "gaussian",
                "title": "Type",
                "type": "string",
                "description": "Type of pre-processing."
              },
              "sigma_xy": {
                "default": 2.0,
                "exclusiveMinimum": 0,
                "title": "Sigma Xy",
                "type": "number",
                "description": "Standard deviation for Gaussian kernel in XY plane."
              },
              "sigma_z": {
                "title": "Sigma Z",
                "type": "number",
                "description": "Standard deviation for Gaussian kernel in Z axis. If not specified, no smoothing is applied in Z axis."
              }
            },
            "title": "GaussianFilter",
            "type": "object"
          },
          "IteratorConfiguration": {
            "description": "Advanced Masking configuration.",
            "properties": {
              "masking": {
                "$ref": "#/$defs/MaskingConfiguration",
                "title": "Masking Iterator Configuration",
                "description": "If set, the segmentation will be performed only within the confines of the specified mask. A mask can be specified either by a label image or a Masking ROI table."
              },
              "roi_table": {
                "title": "Iterate Over ROIs",
                "type": "string",
                "description": "Name of a ROI table. If set, the segmentation will be applied to each ROI in the table individually. This option can be combined with masking."
              }
            },
            "title": "IteratorConfiguration",
            "type": "object"
          },
          "MaskingConfiguration": {
            "description": "Masking configuration.",
            "properties": {
              "mode": {
                "default": "Table Name",
                "enum": [
                  "Table Name",
                  "Label Name"
                ],
                "title": "Mode",
                "type": "string",
                "description": "Mode of masking to be applied. If \"Table Name\", the identifier refers to a masking table name. If \"Label Name\", the identifier refers to a label image name."
              },
              "identifier": {
                "title": "Identifier",
                "type": "string",
                "description": "Name of the masking table or label image depending on the mode."
              }
            },
            "title": "MaskingConfiguration",
            "type": "object"
          },
          "MedianFilter": {
            "description": "Median filter pre-processing configuration.",
            "properties": {
              "type": {
                "const": "median",
                "default": "median",
                "title": "Type",
                "type": "string",
                "description": "Type of pre-processing."
              },
              "size_xy": {
                "default": 2,
                "exclusiveMinimum": 0,
                "title": "Size Xy",
                "type": "integer",
                "description": "Size in pixels of the median filter in XY plane."
              },
              "size_z": {
                "title": "Size Z",
                "type": "integer",
                "description": "Size in pixels of the median filter in Z axis. If not specified, no filtering is applied in Z axis."
              }
            },
            "title": "MedianFilter",
            "type": "object"
          },
          "NoNorm": {
            "description": "Disable Cellpose normalization.",
            "properties": {
              "mode": {
                "const": "none",
                "default": "none",
                "title": "Mode",
                "type": "string",
                "description": "Do not apply any normalization, and ignore all other parameters."
              }
            },
            "title": "NoNorm",
            "type": "object"
          },
          "PrePostProcessConfiguration": {
            "description": "Configuration for pre- and post-processing steps.",
            "properties": {
              "pre_process": {
                "items": {
                  "discriminator": {
                    "mapping": {
                      "gaussian": "#/$defs/GaussianFilter",
                      "median": "#/$defs/MedianFilter"
                    },
                    "propertyName": "type"
                  },
                  "oneOf": [
                    {
                      "$ref": "#/$defs/GaussianFilter"
                    },
                    {
                      "$ref": "#/$defs/MedianFilter"
                    }
                  ]
                },
                "title": "Pre Process",
                "type": "array",
                "description": "List of pre-processing steps."
              },
              "post_process": {
                "items": {
                  "discriminator": {
                    "mapping": {
                      "size_filter": "#/$defs/SizeFilter"
                    },
                    "propertyName": "type"
                  },
                  "oneOf": [
                    {
                      "$ref": "#/$defs/SizeFilter"
                    }
                  ]
                },
                "title": "Post Process",
                "type": "array",
                "description": "List of post-processing steps."
              }
            },
            "title": "PrePostProcessConfiguration",
            "type": "object"
          },
          "SizeFilter": {
            "description": "Size filter post-processing configuration.",
            "properties": {
              "type": {
                "const": "size_filter",
                "default": "size_filter",
                "title": "Type",
                "type": "string",
                "description": "Type of post-processing."
              },
              "min_size": {
                "minimum": 0,
                "title": "Min Size",
                "type": "integer",
                "description": "Minimum size in pixels for objects to keep."
              }
            },
            "required": [
              "min_size"
            ],
            "title": "SizeFilter",
            "type": "object"
          },
          "SkipCreateMaskingRoiTable": {
            "description": "Skip Creating Masking ROI Table Configuration.",
            "properties": {
              "mode": {
                "const": "Skip Creating Masking ROI Table",
                "default": "Skip Creating Masking ROI Table",
                "title": "Mode",
                "type": "string",
                "description": "Mode to skip creating masking ROI table."
              }
            },
            "title": "SkipCreateMaskingRoiTable",
            "type": "object"
          }
        },
        "additionalProperties": false,
        "properties": {
          "zarr_url": {
            "title": "Zarr Url",
            "type": "string",
            "description": "URL to the OME-Zarr container"
          },
          "channels": {
            "$ref": "#/$defs/CellposeChannels",
            "title": "Channels",
            "description": "Channels to use for segmentation. It must contain between 1 and 3 channel identifiers."
          },
          "label_name": {
            "default": "{channel_identifier}_segmented",
            "title": "Label Name",
            "type": "string",
            "description": "Name of the resulting label image. Optionally, it can contain a placeholder \"{channel_identifier}\" which will be replaced by the first channel identifier specified in the channels parameter."
          },
          "level_path": {
            "title": "Level Path",
            "type": "string",
            "description": "If the OME-Zarr has multiple resolution levels, the level to use can be specified here. If not provided, the highest resolution level will be used."
          },
          "iterator_configuration": {
            "$ref": "#/$defs/IteratorConfiguration",
            "title": "Iterator Configuration",
            "description": "Configuration for the segmentation iterator. This can be used to specify masking and/or a ROI table."
          },
          "custom_model": {
            "title": "Custom Model",
            "type": "string",
            "description": "Path to a custom Cellpose model. If not set, the default \"cpsam\" model will be used."
          },
          "advanced_parameters": {
            "$ref": "#/$defs/AdvancedCellposeParameters",
            "default": {
              "normalization": {
                "mode": "default"
              },
              "batch_size": 8,
              "resample": true,
              "invert": false,
              "diameter": null,
              "flow_threshold": 0.4,
              "cellprob_threshold": 0.0,
              "flow3D_smooth": 0,
              "anisotropy": null,
              "do_3D": true,
              "stitch_threshold": 0.0,
              "min_size": 15,
              "max_size_fraction": 0.4,
              "niter": null,
              "augment": false,
              "tile_overlap": 0.1,
              "bsize": 256,
              "verbose": false
            },
            "title": "Advanced Parameters",
            "description": "Advanced parameters for Cellpose segmentation."
          },
          "pre_post_process": {
            "$ref": "#/$defs/PrePostProcessConfiguration",
            "default": {
              "pre_process": [],
              "post_process": []
            },
            "title": "Pre Post Process",
            "description": "Configuration for pre- and post-processing steps."
          },
          "create_masking_roi_table": {
            "default": {
              "mode": "Skip Creating Masking ROI Table"
            },
            "discriminator": {
              "mapping": {
                "Create Masking ROI Table": "#/$defs/CreateMaskingRoiTable",
                "Skip Creating Masking ROI Table": "#/$defs/SkipCreateMaskingRoiTable"
              },
              "propertyName": "mode"
            },
            "oneOf": [
              {
                "$ref": "#/$defs/CreateMaskingRoiTable"
              },
              {
                "$ref": "#/$defs/SkipCreateMaskingRoiTable"
              }
            ],
            "title": "Create Masking Roi Table",
            "description": "Configuration to create a masking ROI table after segmentation."
          },
          "overwrite": {
            "default": true,
            "title": "Overwrite",
            "type": "boolean",
            "description": "Whether to overwrite an existing label image. Defaults to True."
          }
        },
        "required": [
          "zarr_url",
          "channels"
        ],
        "type": "object",
        "title": "CellposeSamSegmentationTask"
      },
      "docs_link": "https://github.com/fractal-analytics-platform/fractal-cellpose-sam-task"
    }
  ],
  "has_args_schemas": true,
  "args_schema_version": "pydantic_v2",
  "authors": "Lorenzo Cerrone"
}
